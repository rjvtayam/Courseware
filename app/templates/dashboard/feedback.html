{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8">
        Manage Feedback - {{ assignment.title }}
    </h1>
    
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="mb-6">
            <label for="student-select" class="block text-sm font-medium text-gray-700 mb-2">
                Select Student
            </label>
            <select 
                id="student-select"
                onchange="loadStudentFeedback(this.value)"
                class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
            >
                <option value="">Choose a student...</option>
                {% for student in students %}
                <option value="{{ student.id }}">{{ student.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <form id="feedback-form" onsubmit="submitFeedback(event)" class="space-y-6">
            <input type="hidden" id="student-id" name="student_id">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div>
                <label for="grade" class="block text-sm font-medium text-gray-700 mb-2">
                    Grade (0-100)
                </label>
                <input 
                    type="number" 
                    id="grade" 
                    name="grade"
                    min="0"
                    max="100"
                    step="0.1"
                    class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                    required
                >
                <div id="grade-error" class="mt-1 text-sm text-red-600 hidden"></div>
            </div>
            
            <div>
                <label for="feedback" class="block text-sm font-medium text-gray-700 mb-2">
                    Feedback
                </label>
                <textarea 
                    id="feedback" 
                    name="feedback"
                    rows="4"
                    class="w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                    required
                    maxlength="5000"
                ></textarea>
                <div id="feedback-error" class="mt-1 text-sm text-red-600 hidden"></div>
                <div class="mt-1 text-sm text-gray-500">
                    <span id="feedback-length">0</span>/5000 characters
                </div>
            </div>
            
            <div class="flex justify-end">
                <button 
                    type="submit"
                    class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    id="submit-button"
                >
                    Save Feedback
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let socket = io({
    reconnection: true,
    reconnectionAttempts: 5,
    reconnectionDelay: 1000
});

socket.on('connect', function() {
    console.log('Connected to WebSocket server');
});

socket.on('connect_error', function(error) {
    console.error('Socket.IO connection error:', error);
});

socket.on('disconnect', function(reason) {
    console.log('Disconnected from WebSocket server:', reason);
});

function showError(elementId, message) {
    const errorDiv = document.getElementById(elementId + '-error');
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }
}

function hideError(elementId) {
    const errorDiv = document.getElementById(elementId + '-error');
    if (errorDiv) {
        errorDiv.classList.add('hidden');
    }
}

function validateGrade(grade) {
    const value = parseFloat(grade);
    if (isNaN(value)) {
        showError('grade', 'Please enter a valid number');
        return false;
    }
    if (value < 0 || value > 100) {
        showError('grade', 'Grade must be between 0 and 100');
        return false;
    }
    hideError('grade');
    return true;
}

function validateFeedback(feedback) {
    if (!feedback.trim()) {
        showError('feedback', 'Feedback cannot be empty');
        return false;
    }
    if (feedback.length > 5000) {
        showError('feedback', 'Feedback is too long (maximum 5000 characters)');
        return false;
    }
    hideError('feedback');
    return true;
}

function updateFeedbackLength() {
    const feedback = document.getElementById('feedback');
    const lengthDisplay = document.getElementById('feedback-length');
    if (feedback && lengthDisplay) {
        lengthDisplay.textContent = feedback.value.length;
    }
}

function loadStudentFeedback(studentId) {
    if (!studentId) {
        document.getElementById('feedback-form').reset();
        updateFeedbackLength();
        return;
    }

    document.getElementById('student-id').value = studentId;
    const submitButton = document.getElementById('submit-button');
    if (submitButton) {
        submitButton.disabled = true;
    }

    fetch(`/api/feedback/{{ assignment.id }}/${studentId}`, {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(function(response) {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(function(data) {
        document.getElementById('grade').value = data.grade || '';
        document.getElementById('feedback').value = data.feedback || '';
        updateFeedbackLength();
        if (submitButton) {
            submitButton.disabled = false;
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        alert('Failed to load feedback. Please try again.');
        document.getElementById('feedback-form').reset();
        updateFeedbackLength();
        if (submitButton) {
            submitButton.disabled = false;
        }
    });
}

function submitFeedback(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const studentId = document.getElementById('student-id').value;
    const grade = formData.get('grade');
    const feedback = formData.get('feedback');

    if (!studentId) {
        alert('Please select a student first');
        return;
    }

    if (!validateGrade(grade) || !validateFeedback(feedback)) {
        return;
    }

    const submitButton = document.getElementById('submit-button');
    if (submitButton) {
        submitButton.disabled = true;
    }

    fetch('/teacher/feedback/{{ assignment.id }}', {
        method: 'POST',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: formData,
        credentials: 'same-origin'
    })
    .then(function(response) {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(function(data) {
        if (data.success) {
            alert('Feedback saved successfully!');
            if (socket && socket.connected) {
                socket.emit('feedback_submitted', {
                    assignment_id: parseInt('{{ assignment.id }}'),
                    student_id: parseInt(studentId)
                });
            }
        } else {
            alert('Failed to save feedback. Please try again.');
        }
    })
    .catch(function(error) {
        console.error('Error:', error);
        alert('Failed to save feedback. Please try again.');
    })
    .finally(function() {
        if (submitButton) {
            submitButton.disabled = false;
        }
    });
}

// Add character counter for feedback
document.getElementById('feedback').addEventListener('input', updateFeedbackLength);
</script>
{% endblock %}
